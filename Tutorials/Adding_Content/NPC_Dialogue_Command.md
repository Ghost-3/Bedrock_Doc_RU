# Команда диалога NPC

Branching Dialogue позволяет вам создать динамический сценарий диалога NPC, который может предоставлять обновленный
диалог на основе внутриигровых действий или ответов игрока. Система Branching Dialogue состоит из трех частей:
NPC-сущность, команды диалога и файлы ресурсов сцен.

### Требования

Перед началом этого урока рекомендуется выполнить следующее.

+ [Создание пользовательского NPC](Create_a_Custom_NPC.md)

## Файл сцены

Файл сцены - это json-файл, расположенный в папке диалога в корневом каталоге вашего пакета поведения (`
%localappdata%\Packages\Microsoft.MinecraftUWP_8wekyb3d8bbwe\LocalState\games\com.mojang\development_behavior_packs\<папка вашего Behavior Pack>`)
, который содержит всю информацию, необходимую для вашего ветвящегося диалога. Вы можете создать столько файлов сцен,
сколько вам нужно. Вы можете создать файл сцены для каждого NPC в вашем мире или создать файл сцены для каждой главы
вашего повествования, или просто иметь один файл сцены для всего мира - выбор полностью зависит от вас, так как функция
ветвящегося диалога будет читать все файлы в папке диалога, независимо от того, как вы решили их организовать.

### Свойства

Первое свойство - это заголовок, который определяет этот json-файл как действительный файл сцены.

Пример:

``` json
{
    "format_version": "1.17",
    "minecraft:npc_dialogue": {}
}
```

Поскольку это json-файл, нам нужно включить скобки. Следующее свойство, которое мы добавим - это свойство "scenes",
место, где будут жить все наши разветвленные диалоги.

``` json
{
    "format_version": "1.17",
    "minecraft:npc_dialogue": {
        "scenes": []
    }
}
```

После создания заголовка и свойств файла сцены мы можем создать отдельные сцены для ветвящегося диалога NPC. Для каждого
нового экземпляра диалога NPC потребуется новая сцена. Она определяется в файле сцены путем создания тега scene. Вы
будете использовать тег сцены в игре для вызова текста, который вы зададите в файле сцены. Вы также можете установить
кнопки и команды NPC, которые будут вести себя так же, как если бы вы установили их с помощью внутриигрового редактора
NPC.

Давайте рассмотрим структуру сцены NPC:

``` json
{
    "scene_tag": "ducky_intro",
    "npc_name": "Ducky",
    "text": "Hello. My name is Ducky. Take this gold!",
    "on_open_commands": [
        "/clear @p"
    ],
    "on_close_commands": [
        "/say Enjoy the gold! "
    ],
    "buttons": [
        {
            "name": "Take Gold",
            "commands": [
                "/give @initiator gold_ingot"
            ]
        }
    ]
}
```

### Свойства сцены

**scene_tag**: Это имя, которое вы будете использовать для вызова этой сцены в игре. Это обязательное свойство.

**npc_name**: Здесь вы можете добавить или изменить имя для диалогового окна NPC. Это необязательное свойство, полезное
для динамического изменения имен NPC.

**text**: Здесь вводится диалог, который NPC должен отображать в игре для данной сцены. Вы можете ввести текст диалога
непосредственно здесь или использовать необработанный текст, если вы используете языковой файл. Это необязательное
свойство, но без него диалоговое окно NPC будет пустым.

**on_open_commands**: Здесь вы можете определить, какие команды будут выполняться при открытии диалогового окна NPC.
Необязательное свойство.

**on_close_command**: Здесь вы можете определить, какие команды будут выполняться при закрытии диалогового окна NPC.
Необязательное свойство.

**buttons**: Здесь вы можете создать кнопки для NPC. Подмножество включает свойства "имя" и "команды". Свойство "name"
позволяет задать текст, который будет отображаться на кнопке NPC. Второе свойство - "commands" - позволяет добавить
команды, которые будут выполняться в игре при нажатии кнопки. Необязательное свойство; требуется для кнопок NPC.

### Rawtext

Все перечисленные выше свойства сцены поддерживают rawtext.

``` json
{
    "scene_tag": "ducky_intro",
    "npc_name": { "rawtext": [ { "translate": "character.name", "with": ["\n"] } ] },
    "text": { "rawtext": [ { "translate": "ducky.intro.text", "with": ["\n"] } ] },
    "on_open_commands": ["/clear @p"],
    "on_close_commands": ["/say Enjoy the gold! "],
    "buttons": [
        {
            "name": { "rawtext": [ { "translate": "dialogue.button.name" } ] },
            "commands": [
                "/give @initiator gold_ingot"
            ]
        }
    ]
}
```

## Команда Dialogue

Команда Dialogue позволяет NPC открывать или читать файлы сцен. Команда имеет два различных режима, каждый из которых
имеет свою уникальную цель и синтаксис.

### Dialogue Open

Dialogue Open используется для принудительного открытия диалогового окна NPC для целевого игрока (игроков). Эта функция
ранее называлась Remote Fire, так как она имитирует нажатие на NPC. Эта команда может быть использована для любого NPC и
не требует пакета поведения, если только вы не хотите, чтобы NPC использовал файл сцены для своего диалога (что не
является обязательным условием при использовании функции открытия диалога).

Синтаксис команды Dialogue Open следующий:

```
/dialogue open <npc: target> <player: target> [sceneName:string]
```

`/dialogue`: Начальная команда.

`open`: Вариант команды.

`<npc: target>`: NPC, на которого вы нацеливаетесь.

`<игрок: цель>`: игрок, на которого вы нацелились. Это игрок, который увидит диалоговое окно NPC.

`[sceneName:string]`: Это имя используется, если вы хотите использовать диалог, содержащийся в файле сцены. Строка
должна быть действительным именем тега сцены, иначе произойдет сбой. Это необязательный параметр.

> Примечание
>
> Если имя сцены не указано, то отображается последний диалог, который был у NPC.

### Практическое использование

Второй способ использования Dialogue Open - это создание разветвленных деревьев диалогов с помощью файла сцены.
Используя команду Dialogue Open внутри файла сцены NPC, NPC может автоматически открыть следующее диалоговое окно для
игрока, используя команду On Close или команду Button. Это основа для всех путей ветвления диалогового дерева.

### Dialogue Change

Dialogue change используется для того, чтобы направить NPC на использование диалога, представленного в специально
указанном файле сцены. Для правильной работы этой команды необходимо использовать пакет поведения, содержащий папку
диалога и файл сцены. Команда даст указание NPC извлечь диалог из места, указанного в имени тега сцены. Команда должна
быть запущена до того, как игрок начнет контакт с NPC.

Синтаксис команды Dialogue change следующий:

```
/dialogue change <npc: target> <sceneName:string> [player: target]
```

`/dialogue`: Начальная команда.

`change`: Вариант команды.

`<npc: target>`: NPC, на которого вы нацелились.

`<sceneName:string>`: Это имя используется, если вы хотите использовать диалог, содержащийся в файле сцены. Строка
должна быть действительным именем тега сцены, иначе произойдет сбой.

`[player: target]`: Игрок, на которого вы нацеливаетесь (это игрок увидит диалоговое окно). Если опущена в команде "
/dialogue change", диалог NPC будет обновлен для всех игроков.

## Targeting

Targeting - это жизненно важная часть системы ветвления диалогов NPC. Она определяет, какие NPC получают команды и какие
игроки видят диалог. Она также используется для того, чтобы каждый игрок видел тот диалог, который вы хотите, и не терял
диалог в многопользовательских сценариях.

### Targeting NPCs

Чтобы использовать команду `/dialogue`, вы должны выбрать NPC. Это будет действовать как NPC, от которого появляется
диалог, и будет использовать изображение этого NPC в портрете диалога.

NPC, от которого вы хотите вызвать диалог, должен существовать в мире.

### Targeting Players

При использовании команды `/dialogue` могут возникнуть ситуации, когда вам потребуется указать игроков. Чтобы выбрать
игроков, используйте селекторы игроков, такие как @a (все игроки) или @p (ближайший игрок). Обычно они хорошо подходят
для одиночной игры, но если вы хотите изменить сцену для каждого игрока, вам нужно использовать специальный тип цели,
называемый @initiator (игрок, взаимодействующий с NPC).

Пример:

``` json
"buttons": [
    {
        "name": { "rawtext": [ { "translate": "dialogue.button.name" } ] },
        "commands": [
            "/give @initiator gold_ingot"
        ]
    }
]
```

Использование этого селектора целей с NPC позволяет им обновлять свой диалог для каждого игрока, что означает, что в
многопользовательской игре NPC могут запоминать состояние диалога каждого игрока и посылать им уникальный диалог
соответственно. Это полезно в тех случаях, когда игрок, изменяющий диалог NPC, может привести к тому, что другие игроки
пропустят полную ветку диалога, или для того, чтобы каждый игрок получал от NPC только один предмет, не позволяя тому же
игроку вернуться к NPC за новыми предметами или блокируя других игроков от сбора предметов.

## Полный пример:

``` json
{
    "format_version": "1.17",
    "minecraft:npc_dialogue": {
        "scenes": [
            {
                "scene_tag": "ducky_intro",
                "npc_name": { "rawtext": [ { "translate": "character.name", "with": ["\n"] } ] },
                "text": { "rawtext": [ { "translate": "ducky.intro.text", "with": ["\n"] } ] },
                "on_open_commands": ["/clear @p"],
                "on_close_commands": ["/say Enjoy the gold! "],
                "buttons": [
                    {
                        "name": { "rawtext": [ { "translate": "dialogue.button.name" } ] },
                        "commands": [
                            "/give @initiator gold_ingot"
                        ]
                    }
                ]
            }
        ]
    }
}
```

Команда для запуска сцены:

```
/dialogue open @e[tag=ducky] @p ducky_intro
```