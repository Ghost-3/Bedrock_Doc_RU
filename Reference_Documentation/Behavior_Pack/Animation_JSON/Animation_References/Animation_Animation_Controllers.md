# Документация по анимации - Контроллеры анимации

Формат контроллера анимации записан в JSON и отформатирован, как показано ниже:

### Формат контроллера анимации

``` json
{
  "format_version": "1.10.0",
  "animation_controllers": {
    "controller.animation.sheep.move": {
      "states": {
        "default": {
          "animations": [
            { "walk": "query.modified_move_speed" }
          ],
          "transitions": [
            { "grazing": "query.is_grazing" }
          ]
        },
        "grazing": {
          "animations": [ "grazing" ],
          "transitions": [
            { "default": "query.all_animations_finished" }
          ]
        }
      }
    }
  }
}
```

## Состояния

Каждое состояние имеет необязательный раздел переменных, в котором перечисляется любое количество переменных, которые
могут использовать ссылающиеся анимации. Каждое состояние также имеет одну или несколько анимаций, используя имя,
указанное в json определении сущности.

### Переменные состояния

Переменные имеют значение, задаваемое выражением Моланга. Их значение также может быть изменено с помощью
линейно-интерполированной кривой.

#### Пример

Здесь представлен контроллер анимации для одного кадра. Он принимает значение `query.ground_speed`, затем изменяет его
на 0,2-0,7, основываясь на значении `query.ground_speed` от 0,0 до 1,0. Будет воспроизведена одна анимация ходьбы,
которая будет изменяться от 0,0 до 1,0 по мере увеличения скорости движения земли от остановки до 2,3 м/с. Кривая ремапа
может иметь любое количество входов. Затем контроллер анимации воспроизведет анимацию `wiggle_nose` со ссылкой на
сущность, а затем анимацию `walk`, масштабируя последнюю на значение `variable.ground_speed_curve`.

``` json
{
  "format_version": "1.10.0",
  "animation_controllers": {
    "controller.animation.sheep.move": {
      "states": {
        "default": {
          "variables": {
            "ground_speed_curve": {
              "input": "query.ground_speed",
              "remap_curve": {
                "0.0": 0.2,
                "1.0": 0.7
              }
            }
          },
          "animations": [
            "wiggle_nose",
            { "walk": "variable.ground_speed_curve" }
          ]
        }
      }
    }
  }
}
```

#### Пример сценария, определяемого пользователем

> Примечание
>
> "pre_animation" указывает скрипту выяснить значения этих переменных раз в кадр, до того, как произойдет анимация, чтобы анимация могла использовать эти значения в своих формулах. Если переменная не существовала, то будет создана новая переменная и ее значение по умолчанию будет 0.0.

В definitions\entity\tiger.json:

``` json
{
  "custom:tiger":{
    "scripts":{
      "pre_animation": {
        "variable.foo = math.sin(query.life_time);"
      }
    }
  }
}
```

От 0 до -1 до 0, где будет играть только "base_pose", а затем равное количество времени, где Walk будет играть поверх
base_pose по мере того, как foo будет переходить от 0 к 1 и обратно к 0. Base_pose будет иметь значение смешивания 1.0.

``` json
"controller.animation.tiger.move": {
  "states": {
    "default": {
      "animations": [
        //анимации являются ДОПОЛНИТЕЛЬНЫМИ, если не указано иное
        //в этом случае base_pose всегда будет играть в состоянии по умолчанию
        //walk будет воспроизводиться, если Entity.foo больше 0.0
        "base_pose",
        { "walk": "variable.foo > 0.0" }
      ]
    }
  }
}
```

### Переходы состояний

Каждый переход имеет целевое состояние, в которое он должен перейти, и сценарий, определяющий, должен ли он перейти или
нет. Для каждого перехода по порядку оцените сценарий, и если он возвращает ненулевое значение, немедленно переключитесь
в указанное состояние. ПРИМЕЧАНИЕ: В каждом кадре будет обработан только один переход.

``` json
"<controller_name>": {
  "states": {
    "<state_name>": {
      "transitions": [
        // Evaluate the below expressions in order.
        // The first to return non-zero is the state to transition to.
        // If all are zero, then don't transition.
        {"<target_state_name_A>", "<expression>" },
        {"<target_state_name_B>", "<expression>" },
      ]
    }
  },
}
```

#### Пример перехода состояния

``` json
"controller.animation.tiger.move": {
  "states": {
    "default": {
      "animations": [ "base_pose", "walk" ],
      "transitions": [
        { "angry": "query.is_angry" }, // переход в состояние гнева, если query.is_angry возвращает true
        { "tired": "variable.is_tired" } // переход в состояние усталости, если переменная.is_tired возвращает true
      ]
    },
    "angry": {
      "animations": [ "roar", "extend_claws" ],
      "transitions": [
        { "default": "query.any_animation_finished" } // переход обратно в состояние по умолчанию, когда завершается анимация рыка или анимация extend_claws
      ]
    },
    "tired": {
      "animations": [ "yawn", "stretch" ],
      "transitions": [
        { "default": "query.all_animation_finished" } // переход обратно в состояние по умолчанию после завершения анимации зевка и потягивания
      ]
    }
  }
}
```

### Смешивание состояний

время, которое вы хотите, чтобы система использовала для смешивания двух состояний. Это делается как простое
переключение между двумя состояниями в течение указанного времени.

#### Пример смешивания между двумя состояниями

``` json
"controller.animation.tiger.move": {
  "states": {
    "default": {
      "animations": [ "base_pose", "walk" ],
      "transitions": [
        { "angry": "query.is_angry" } // переход в состояние гнева, если query.is_angry возвращает true
      ],
      "blend_transition": 0.2          // при переходе из этого состояния, перекрестное затухание в течение 0,2 секунды
    },
    "angry": {
      "animations": [ "roar", "extend_claws" ],
      "transitions": [
        { "default": "query.any_animation_finished" } // переход обратно в состояние по умолчанию, когда завершается анимация рыка или анимация extend_claws
      ]
    }
  }
}
```

## Каналы (вращение, положение, масштаб)

Механизм отслеживает анимацию вращения, положения и масштабирования по отдельности. Внутри канала задается один или
несколько ключевых кадров в произвольное время, в секундах, от начала анимации. Если ключевые кадры не указаны,
создается один ключевой кадр в момент t=0.0, и все данные канала сохраняются в этом ключевом кадре.

## Примеры формата анимации сущности

Ниже приведены общие примеры записи формата анимации в JSON. Примечание В соответствии с форматом геометрии, единицы
измерения - 1/16 метра.

``` json
<animation_name>": {
  // дополнительно
  "loop": <bool>                                       // по умолчанию = false.  Должна ли анимация по окончании вернуться к t=0.0?
  "blend_weight": <expression>                         // по умолчанию = "1.0".  Насколько сильно эта анимация смешивается с остальными.  0.0 = выключено.  1.0 = полностью применять все преобразования.  Может быть выражением - см. раздел "Контроллер анимации" ниже.
  "animation_length": <float>                          // по умолчанию = время последнего ключевого кадра.  В какое время система считает эту анимацию завершенной?
  "override_previous_animation": <bool>                // по умолчанию = false.  Должна ли анимационная поза кости быть установлена в позу привязки перед применением этой анимации, тем самым отменяя все предыдущие анимации до этого момента?

  // требуется
  "bones": [
    {
    "<bone_name>": {                                   // должно совпадать с именем кости, указанной в геометрическом скелете
      // различные варианты установки данных
      // опускание канала пропускает этот канал для данной анимации этой кости
      // любое количество плавающих значений ниже может быть заменено строковым выражением, как описано выше; не обязательно заменять все плавающие значения в строке выражениями, только те, которые вы хотите, чтобы были основаны на выражении
      "position": 1.0,                                 // установите x, y и z равными 1
      "position": [1.0],                               // установите x, y и z равными 1
      "position": [1.0, 2.0, 3.0],                     // установить x=1, y=2 и z=3
      "rotation": 45.0,                                // установите x, y и z на 45 градусов
      "rotation": [45.0],                              // установить x, y и z на 45 градусов
      "rotation": [30.0, 0.0, 45.0],                   // установите x, y и z в соответствующие значения (в градусах)
      // примечание: в настоящее время поддерживается только равномерное масштабирование
      "scale": 2.0,                                    // масштабирует кость на 2,0
      "scale": [2.0],                                  // масштабирует кость на 2,0
      // Данные ключевого кадра описаны ниже
      // Обратите внимание, что любой из приведенных выше стилей значений будет работать для "до" и "после", и "до" не обязательно должно иметь тот же формат, что и "после".
      "rotation": {
        "0.0": [80.0, 0.0, 0.0],
        "0.1667": [-80.0, 0.0, 0.0],
        "0.333": [80.0, 0.0, 0.0]
      }
      // Для прерывистой кривой канала можно задать другое значение при интерполяции к/от данного ключевого кадра
      "rotation": {
        "0.3": {                                       // поле key - метка времени для данного ключевого кадра: значение может быть любым из следующих вариантов the above examples
        "pre": [30.0, 0.0, 45.0],                      // при интерполяции к данному ключевому кадру от предыдущего, используйте это значение
        "post": "180.0 * Math.Sin(global.key_frame_lerp_time)"  // при интерполяции от этого ключевого кадра к следующему, используйте это значение
        }
      }
      // another example
      "rotation": {
        "0.0": [80.0, 0.0, 0.0],                       // начать вращение по оси x на 80 градусов
        "0.4": {
        "pre": [80.0, 0.0, 0.0],                       // оставаться на 80 до истечения 0,4 секунды
        "post": [0.0, 0.0, 0.0],                       // прерывисто изменяйте вращение по оси x до 0,0 градусов
        },
        "0.8": [-80.0, 0.0, 0.0]                       // используя режим lerp предыдущего кадра, выполнить lerp до поворота по оси x на -80 градусов на 0,8 секунды
      }
    }
  ]
}
```
